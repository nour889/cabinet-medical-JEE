package org.projet.cabinet.dao; import java.sql.*; import java.time.*; import java.util.ArrayList; import java.util.List; import javax.servlet.ServletContext; import org.projet.cabinet.model.*;
public class VisiteDao extends DaoBase {
    public VisiteDao(ServletContext contexte) { super(contexte); }
    private Visite mapperVisite(ResultSet rs) throws SQLException { Utilisateur u = new Utilisateur(); u.setId(rs.getInt("utilisateur_id")); u.setNom(rs.getString("nom")); u.setPrenom(rs.getString("prenom")); u.setEmail(rs.getString("email")); u.setMotDePasse(rs.getString("mot_de_passe")); String roleTexte = rs.getString("role"); if (roleTexte != null) { u.setRole(RoleUtilisateur.valueOf(roleTexte)); } Patient p = new Patient(); p.setId(rs.getInt("patient_id")); p.setUtilisateur(u); Date dateNaissanceSql = rs.getDate("date_naissance"); if (dateNaissanceSql != null) { p.setDateNaissance(dateNaissanceSql.toLocalDate()); } p.setTelephone(rs.getString("telephone")); RendezVous r = new RendezVous(); r.setId(rs.getInt("rendezvous_id")); Date dateRdvSql = rs.getDate("date_rdv"); if (dateRdvSql != null) { r.setDateRdv(dateRdvSql.toLocalDate()); } Time heureRdvSql = rs.getTime("heure_rdv"); if (heureRdvSql != null) { r.setHeureRdv(heureRdvSql.toLocalTime()); } String statutTexte = rs.getString("statut"); if (statutTexte != null) { r.setStatut(StatutRendezVous.valueOf(statutTexte)); } Visite v = new Visite(); v.setId(rs.getInt("id")); v.setPatient(p); v.setRendezVous(r); v.setMotif(rs.getString("motif")); Timestamp dateVisiteTs = rs.getTimestamp("date_visite"); if (dateVisiteTs != null) { v.setDateVisite(dateVisiteTs.toLocalDateTime()); } return v; }
    public Visite creer(Visite visite) { String sql = "INSERT INTO visites (patient_id, rendezvous_id, motif, date_visite) VALUES (?,?,?,NOW())"; try (Connection connexion = obtenirConnexion(); PreparedStatement ps = connexion.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) { ps.setInt(1, visite.getPatient().getId()); ps.setInt(2, visite.getRendezVous().getId()); ps.setString(3, visite.getMotif()); ps.executeUpdate(); try (ResultSet rs = ps.getGeneratedKeys()) { if (rs.next()) { visite.setId(rs.getInt(1)); } } return visite; } catch (SQLException e) { throw new RuntimeException("Erreur lors de la création de la visite", e); } }
    public Visite trouverParId(int id) { String sql = "SELECT v.id, v.patient_id, v.rendezvous_id, v.motif, v.date_visite, p.date_naissance, p.telephone, u.id AS utilisateur_id, u.nom, u.prenom, u.email, u.mot_de_passe, u.role, r.date_rdv, r.heure_rdv, r.statut FROM visites v JOIN patients p ON v.patient_id = p.id JOIN utilisateurs u ON p.utilisateur_id = u.id LEFT JOIN rendezvous r ON v.rendezvous_id = r.id WHERE v.id = ?"; try (Connection connexion = obtenirConnexion(); PreparedStatement ps = connexion.prepareStatement(sql)) { ps.setInt(1, id); try (ResultSet rs = ps.executeQuery()) { if (rs.next()) { return mapperVisite(rs); } return null; } } catch (SQLException e) { throw new RuntimeException("Erreur lors de la recherche de la visite par id", e); } }
    public List<Visite> trouverParPatientId(int patientId) { String sql = "SELECT v.id, v.patient_id, v.rendezvous_id, v.motif, v.date_visite, p.date_naissance, p.telephone, u.id AS utilisateur_id, u.nom, u.prenom, u.email, u.mot_de_passe, u.role, r.date_rdv, r.heure_rdv, r.statut FROM visites v JOIN patients p ON v.patient_id = p.id JOIN utilisateurs u ON p.utilisateur_id = u.id LEFT JOIN rendezvous r ON v.rendezvous_id = r.id WHERE v.patient_id = ? ORDER BY v.date_visite DESC"; List<Visite> visites = new ArrayList<>(); try (Connection connexion = obtenirConnexion(); PreparedStatement ps = connexion.prepareStatement(sql)) { ps.setInt(1, patientId); try (ResultSet rs = ps.executeQuery()) { while (rs.next()) { visites.add(mapperVisite(rs)); } } return visites; } catch (SQLException e) { throw new RuntimeException("Erreur lors du chargement des visites du patient", e); } }
    public List<Visite> trouverTous() { String sql = "SELECT v.id, v.patient_id, v.rendezvous_id, v.motif, v.date_visite, p.date_naissance, p.telephone, u.id AS utilisateur_id, u.nom, u.prenom, u.email, u.mot_de_passe, u.role, r.date_rdv, r.heure_rdv, r.statut FROM visites v JOIN patients p ON v.patient_id = p.id JOIN utilisateurs u ON p.utilisateur_id = u.id LEFT JOIN rendezvous r ON v.rendezvous_id = r.id ORDER BY v.date_visite DESC"; List<Visite> visites = new ArrayList<>(); try (Connection connexion = obtenirConnexion(); PreparedStatement ps = connexion.prepareStatement(sql); ResultSet rs = ps.executeQuery()) { while (rs.next()) { visites.add(mapperVisite(rs)); } return visites; } catch (SQLException e) { throw new RuntimeException("Erreur lors du chargement de toutes les visites", e); } }
    public List<Visite> trouverVisitesRecentes() { String sql = "SELECT v.id, v.patient_id, v.rendezvous_id, v.motif, v.date_visite, p.date_naissance, p.telephone, u.id AS utilisateur_id, u.nom, u.prenom, u.email, u.mot_de_passe, u.role, r.date_rdv, r.heure_rdv, r.statut FROM visites v JOIN patients p ON v.patient_id = p.id JOIN utilisateurs u ON p.utilisateur_id = u.id LEFT JOIN rendezvous r ON v.rendezvous_id = r.id WHERE v.date_visite >= (NOW() - INTERVAL 1 DAY) ORDER BY v.date_visite DESC"; List<Visite> visites = new ArrayList<>(); try (Connection connexion = obtenirConnexion(); PreparedStatement ps = connexion.prepareStatement(sql); ResultSet rs = ps.executeQuery()) { while (rs.next()) { visites.add(mapperVisite(rs)); } return visites; } catch (SQLException e) { throw new RuntimeException("Erreur lors du chargement des visites des 24 dernières heures", e); } }
    public List<Visite> trouverParRendezVousId(int rendezVousId) { String sql = "SELECT v.id, v.patient_id, v.rendezvous_id, v.motif, v.date_visite, p.date_naissance, p.telephone, u.id AS utilisateur_id, u.nom, u.prenom, u.email, u.mot_de_passe, u.role, r.date_rdv, r.heure_rdv, r.statut FROM visites v JOIN patients p ON v.patient_id = p.id JOIN utilisateurs u ON p.utilisateur_id = u.id LEFT JOIN rendezvous r ON v.rendezvous_id = r.id WHERE v.rendezvous_id = ? ORDER BY v.date_visite DESC"; List<Visite> visites = new ArrayList<>(); try (Connection connexion = obtenirConnexion(); PreparedStatement ps = connexion.prepareStatement(sql)) { ps.setInt(1, rendezVousId); try (ResultSet rs = ps.executeQuery()) { while (rs.next()) { visites.add(mapperVisite(rs)); } } return visites; } catch (SQLException e) { throw new RuntimeException("Erreur lors du chargement des visites du rendez-vous", e); } }
    public List<Visite> trouverPatientsArrives() { String sql = "SELECT v.id, v.patient_id, v.rendezvous_id, v.motif, v.date_visite, p.date_naissance, p.telephone, u.id AS utilisateur_id, u.nom, u.prenom, u.email, u.mot_de_passe, u.role, r.date_rdv, r.heure_rdv, r.statut FROM visites v JOIN patients p ON v.patient_id = p.id JOIN utilisateurs u ON p.utilisateur_id = u.id LEFT JOIN rendezvous r ON v.rendezvous_id = r.id WHERE DATE(v.date_visite) = CURDATE() ORDER BY v.date_visite DESC"; List<Visite> visites = new ArrayList<>(); try (Connection connexion = obtenirConnexion(); PreparedStatement ps = connexion.prepareStatement(sql); ResultSet rs = ps.executeQuery()) { while (rs.next()) { visites.add(mapperVisite(rs)); } return visites; } catch (SQLException e) { throw new RuntimeException("Erreur lors du chargement des patients arrivés aujourd'hui", e); } }
    public void modifier(Visite visite) { String sql = "UPDATE visites SET patient_id = ?, rendezvous_id = ?, motif = ? WHERE id = ?"; try (Connection connexion = obtenirConnexion(); PreparedStatement ps = connexion.prepareStatement(sql)) { ps.setInt(1, visite.getPatient().getId()); ps.setInt(2, visite.getRendezVous().getId()); ps.setString(3, visite.getMotif()); ps.setInt(4, visite.getId()); ps.executeUpdate(); } catch (SQLException e) { throw new RuntimeException("Erreur lors de la modification de la visite", e); } }
    public void supprimer(int id) { String sql = "DELETE FROM visites WHERE id = ?"; try (Connection connexion = obtenirConnexion(); PreparedStatement ps = connexion.prepareStatement(sql)) { ps.setInt(1, id); ps.executeUpdate(); } catch (SQLException e) { throw new RuntimeException("Erreur lors de la suppression de la visite", e); } }
}